# Spring Batch

흔히 말하는 엔터프라이즈 시스템에서는 사용자와 직접 상호작용하는 웹 애플리케이션 뿐만 아니라 사용자와 무관하게 일정 주기마다 실행되야 하는 배치 애플리케이션도 필요하다. 

## Batch

일반적인 배치 처리는 두 가지 특징을 가진다.
* 일정량의 데이터를 모아서 한번에 처리
* 일정한 순서에 따라 처리가 수행된다.

배치 처리는 응답성보다 시간당 처리량을 우선시 하는 처리 방식이다. 말 그대로 수천건의 달하는 대량의 데이터를 단시간에 처리하는 모습을 보인다.

일반적인 배치는 여러 다양한 기술을 조합해서 사용하는 경우가 많은데 일반적으로 아래 기술들을 많이 쓴다.

잡 스케쥴러
: 배치처리에서 하나의 실행 단위를 잡(JOB)이라 한다. 보통 수백에서 수천개의 잡이 관리되는데, 이러한 잡을 원할이 실행되기 위해서는 연관관계를 정의하거나 실행 스케쥴을 관리하는 기능이 필요하다.

셀 스크립트
: 셀 스크립트로 하나의 잡을 처리할 수도 있다. 비교적 간단한 처리를 하는데 쓰이지만 복잡한 잡은 상당히 만들기 어렵다.

자바와 같은 프로그래밍 언어
:  프로그래밍 언어로 별도의 애플리케이션을 개발해 잡을 처리 할 수도 있다.  비교적 복잡한 비즈니스 로직을 처리한다거나 파일이나 데이터베이스 데이터 가공 처리등에 활용된다. 

그러면 배치 처리 방식이 반드시 지켜야할 요건은 무엇일까? 물론 시스템에 따라 달라지겠지만 아래것이 대표적인 요건이다.  

* 대량의 데이터를 제한된 리소스로 효율적으로 처리해야한다.
	* 시간당 처리량과도 관련이 있지만 대량의 데이터를 모아 처리하면 처리 시간을 줄일 수 있다. 일정량 내용을 모아서 처리할때는 트랜잭션 처리 역시 일정량 단위로 시작 및 종료할 수 있어야 한다. 또 데이터가 너무 많으면 일정 단위나 건수로 분할하여 멀티 스레드 방식으로 다중 처리를 하던가 입출력을 최대한 자제하는 등 다양한 노력을 기울여야 한다.
* 가능한 한 중단된 작업을 다시 계속할 수 있어야 한다.
	* 대량의 데이터를 처리하는 동안 입력 데이터의 오류가 있거나 시스템 자체의 이상이 발생했을때 대비한 방어 대책도 생각해 둬야 한다. 데이터가 많으면 당연히 처리가 오래걸리는데 중단되고 복구가 될때 까지는 얼마나 시간이 걸릴지 모른다. 따라서 부작용을 줄이기 위해 작업을 이어서 처리하거나 처리 자체를 처음부터 재처리할 수 있도록 만들 필요가 있다. 
* 다양한 실행 조건을 지원해야 한다
	* 특정 시간이 되면 잡 스케줄러가 배치처리를 위한 프로세스를 기동하고, 완료되면 프로세스를 종료시킨다거나, 프로세스를 항상 상주시켜 놓은 상태에서 수시로 배치처리를 기동하는 등 다양한 실행 방식을 수용해야 한다.
* 다양한 입출력 인터페이스를 다룰 수 있어야 한다.
	* 외부 시스템과 연계할 때는 DB는 물론 CSV나 XML과 같은 다양한 파일도 지원해야 한다. 다양한 입출력을 다룰 수 있는 구조라면 배치 처리가 훨씬 쉬워진다.

> delayed batch, on-line batch?

지연된 배치(delayed batch)는 배치처리가 적은 빈도로 실행되고 보통 대량의 데이터를 취급하는 일반적인 배치.
온라인 배치(on-line batch)는 상당히 높은 빈도로  배치 처리해야하는 경우에 많이 쓰인다. 가령 온라인 애플리케이션과 연관되어 웹 화면에서 특정 업무의 상세 보고서를 출력해야 하는 상황이라면 온라인 처리에서는 사용자의 보고서 출력 요청만 접수하고 실제 보고서 생성 내부 동작은 배치러이에 위임해서 처리하게 된다. 이런 조합은 응답 속도, 처리 성능면 모두 좋다. 

## Spring Batch

> Spring Batch?

스프링 배치는 **배치 애플리케이션 프레임워크**이다. 스프링이 가지고 있던 DI 컨테이너나 AOP, 트랜잭션 관리 기능은 기본으로 가지고 있다. 더욱이 앞서 이야기한 배치 처리를 위한 각종 요건을 이미 갖추고 있다. 

* 처리 흐름을 정형화 
	* 단순한 형태의 Tasklet 방식
		* SQL을 한번 실행하거나, 명령을 실행하는 수준의 단순한 처리에 적합
	* 대량의 데이터를 처리하는 청크(Chunk) 방식
			* 데이터의 수집, 가공, 출력과 같은 처리 흐름을 정형화 해서 필요한 부분만 구현한다. 일정 건수가 되었을때 처리하는 트랜잭션은 스프링 배치가 처리한다.
* 다양한 실행 방법을 제공한다.
	* 명령행 실행, 서블릿에서 실행 등 다양한 실행법
* 다양한 데이터 형식으로 입출려할 수 있다.
	* 파일, DB, 메세지 큐 같은 데이터 소스의 입출력을 간단히 처리할 수 있다.
* 배치 처리를 효율적으로 수행할 수 있다.
	* 다중 실행, 병렬 실행, 조건 분기등의 처리방식으로 상황에 맞는 효율적인 처리방법을 선택
* 잡을 관리 할 수 있다
	* 잡이 실행되던 상황을 저장하거나 재시작 할 수 있다.

## Spring Batch의 기본 구조


![enter image description here](https://t1.daumcdn.net/cfile/tistory/99E54D385AE6E8CD08)

JobLauncher
: 배치 애플리케이션 기동을 위한 인터페이스. 모든 배치 애플리케이션은 이 클래스를 통해 실행된다. 

Job 
: 배치 애플리케이션에서 일련의 처리과정을 하나로 묶어 만든 실행단위.

Step
: Job을 구성하는 세부 처리 단위다. 하나의 잡은 다수의 Step으로 구성될 수 있다. 한 잡 처리를 여러 스텝으로 분할하면 세부 처리를 재사용하거나 병렬처리를 적용할 수 있고 조건 분기에 따른 제어도 가능하게 된다. Step은 청크방식이나 태스크릿 방식 중 한가지로 실행된다. Chunk 방식은 일정량의 데이터를 한번에 몰아서 입력, 가공, 출력하는 방식을 말한다. 반면 태스크릿 방식은 처리 방법을 자유롭게 기술할 수 있는 방식을 말한다.

ItemReader, ItemProcessor, ItemWriter
: 스텝을 데이터의 입력, 가공, 출력 세 가지 패턴 처리로 분할하기 위한 인터페이스이다. 배치 애플리케이션의 대부분이 이 세가지 패턴으로 구성된다는 점에 착안에 Chunk방식을 구현할때 이 세 가지 패턴을 사용한다. 

JobRepository 
: 잡이나 스텝의 상태를 관리한다. 이 정보들은 스프링 배치가 정의한 테이블 스키마 형태로 데이터 베이스에 저장된다. 

## Spring Batch의 아키텍처

### 일반적인 잡 스케쥴러

일반적인 엔터프라이즈 환경의 시스템에서는 다수의 잡을 실행할때 선행/후행 관계에 따라 잡을 실행하는데 이때 배치 처리의 실행을 관리하는것일 잡 스케줄러이다. 잡 스케줄러는 아래와 같은 기능을 제공한다.

* 잡 플로우(Job Flow)
	* 선행 잡의 처리 결과를 보고 후행 잡의 실행 여부를 결정한다거나 여러개의 잡을 병행 처리하는 등의 유연한 처리 흐름을 정의할 수 있다.
* 스케줄링
	* 잡의 실행 시간이나 실행 주기를 정의할 수 있다.
* 실행관리
	* 정상 종료한 잡의 실행 이력을 확인하거나 비정상적으로 종료한 잡을 재처리할 수 있다.

잡 스케줄러가 잡을 실행할때는 매번 잡을 실행할 때마다 자바 프로스세스를 기동하고, 처리가 완료되면 그 프로세스를 종료하는 방식
으로 동작한다. 

스프링 배치에서 스텝과 일반적인 잡 스케줄러의 잡을 비교해보면, 스프링 배치가 잡 스케줄러의 역할을 하고 스프링 배치의 스텝이 잡과 비슷한 역할을 한다. 스브링 배치가 스텝의 흐름제어(flow control)을 하거나 스텝 단위로 


### 





> Written with [StackEdit](https://stackedit.io/).
<!--stackedit_data:
eyJoaXN0b3J5IjpbMTQ4NzkyODc0NiwtNzk5NzcxMDU0LC0xND
UzNTYzNzE1LC04MTkzOTIyNDMsMTY5NDAyNTY2OSw3MDA5MjM2
MzMsMTYwODI2OTQsLTM4MjEwNjg5NCwxNDM0MzUyMTU2LDI5MT
g5MTI4MiwtMTczMTEzODc0OSw4NTk1NTU0NjMsODg4OTc3NjA3
XX0=
-->