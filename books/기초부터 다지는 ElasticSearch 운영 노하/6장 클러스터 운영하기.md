# Overview

클러스터 운영하기 

ES 클러스터를 구축한 후에는 안정적으로 운영하기 위한 운영 이슈들이 생겨난다. 예를 들면, ES 버전 업그레이드, 샤드 배치 방식 변경, 인덱스의 댜앙한 설정값 변경등이 있다. 이번 장에서는 이렇게 클러스터 운영과 관련한 다양한 주제들을 살펴보자. 이번 장에서 다룰 내용은 아래와 같다. 

* ES 클러스터 버전 업그레이드
* 인덱스의 샤드 배치 방식 변경
* 운영 중 온라인으로 클러스터나 인덱스 설정 변경하기 
* 인덱스 API 활용하기
* 템플릿 활용하기

# 버전 업그레이드

ES의 새로운 버전은 빠르게 공개된다. 새로운 기능이 추가되고 이전 버전의 버그도 수정된다. 운영 중이 ES의 치명적인 버그가 포함되어 있거나, 꼭 필요한 새로운 기능이 추가되었다면 버전 업그레이드가 필요하다. 

ES에서 버전 업르게리드를 하는 방법은 크게 두 가지가 있다. 

* Full Cluster Restart - 모든 노드를 동시에 재시작하는 방식이며, 다운 타임이 있지만 빠르게 버전 업그레이드가 가능하다.
* Rolling Start - 노드를 순차적으로 한대씩 재시작한다. 다운 타임은 없지만 노드 개수에 따라서 업그레이드에 소요되는 시간이 길어질 수 있다.

Rolling Start 방식은 아래와 같은 순서로 작업 순서를 따라가야 한다. 

* 클러스터내 샤드 할당 기능 비활성화
* 프라이머리 샤드와 레플리카 샤드 데이터 동기화
* 노드 한 대 버전 업그레이드 이후 클러스터 합류 확인
* 클러스터 내 샤드 할당 기능 활성화
* 클러스터 그린 확인

레플리카 샤드가 있는 상태에서 한대에 노드에 장애가 생겨서 클러스터에 제외가 되어도 해당 데이터 노드가 가지고 있던 샤드를 다른 데이터 노드에 재분배하는 것을 알 수 있다. 하지만 ES의 버전 업그레이드 작업은 장애가 아니라 의도적으로 노드를 클러스터에서 제외하는 것이기 때문에, 해당 노드가 클러스터에서 제외되어 있는 동안을 장애 상황으로 판단하고 샤드를 재분배해서는 안된다. 

업그레이드 때문에 클러스터에서 제외된 노드의 샤드를 다른 데이터 노드로 재분배하는 것은 네트워크 비용이나 디스크 I/O 측면에서 큰 낭비다. 

클러스터내에서 샤드가 많으면 많을 수록, 또 샤드의 크기가 크면 클 수록 더 심한 낭비가 된다. 이러한 불상사를 피하기 위해서 업그레이드를 진행하는 동안 클러스터 내 샤드 할당 기능을 비활성화해야 한다. 

## 클러스터 내 샤드 할당 기능 비활성화

아래와 같은 코드를 통해 클러스터 API 설정을 수정하여 진행한다.

```

```


> Written with [StackEdit](https://stackedit.io/).
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTE0MDQ3MDg4NjAsLTExNDE5NzQ2NjksLT
Y0NTg0Mjg5MywtOTU2OTg4NjE4LDEwODcxMDYyODcsNzMwOTk4
MTE2XX0=
-->