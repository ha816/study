# Overview

이번 장에서는 클러스터를 구축하는 방법을 알아보자. 먼저 ES에서 가장 중요한 환경 설정 파일인 elasticsearch.yml 파일을 통해서 어떤 항목들을 설정할 수 있는지, 그리고 성능에 중요한 영향을 미치는 jvm.options 파일을 통해서는 어떤 항목들을 설정할 수 있는지 살펴보자. 

* elasticsearch.yml 파일을 통해 설정할 수 있는 항목들
* jvm.options 파일을 통해 설정할 수 있는 항목들
* 클러스터 구축을 위해 노드들의 역할을 설정하는 방법
* 고가용성을 고려하여 설계된 클러스터를 사용하고 검증하는 방법

# elasticsearch.yml 설정 파일

elasticsearch.yml 파일은 ES를 구성하기 위해 기본이 되는 환경 설정 파일이다. 아래 코드는 ES를 처음 설치했을 때의 기본설정이다. 

```
# ---- Cluster ----
#
# cluster.name: my-application
#
# ---- Gateway ----
#
# gateway.recover_after_nodes: 3
#
# ---- Various ----
#
# action.destructive_requires_name : true
#
```

대부분 설정이 주석으로 처리되어 있으며, 해당 설정에 대한 간략한 설명이 주석으로 제공된다. 기본으로 제공되는 설정과 더불어 필수적으로 알아야 하는 여러 설정을 자세히 알아보자. 


## Cluster 영역

클러스터  영역의 설정은 클러스터 전체에 적용되는 설정이다. cluster.name: my-application의 경우 이름을 설정하는 항목으로 클러스터를 구성하는 모든 노드들은 동일한 클러스터 이름을  사용해야한다. 클러스터 이름을 변경하려면 클러스터내의 모든 노드를 재시작해야 하기 때문에 처음부터 신중해야 한다. 

## Node영역

Node 영역은 해당 노드메낭 적용되는 설정이다. 

node.name: node-1
node.attr.rack: r1

노드의 이름은 클러스내에서 유일해야 한다. ES에는 ${HOSTNAME}이라는 노드의 호스트명을 인식할 수 있는 변수값을 미리 정의해 놓았기 때문에 다음과 같이 설정하면 자동으로 노드의 이름이 호스트명과 같아져서 다른 노드들과 겹치지 않게 설정할 수 있다. 

```
node.name: ${HOSTNAME}$
```

노드 이름 또한 운영 중에는 변경이 불가능하며, 변경하려면 노드를 재시작해야 한다. 클러스터에서는 노드 하나가 서비스에서 제외된다고 큰 문제는 없지만 이름을 변경하기 위해선 불필요하게 재시작이 필요하기에 신중히 설정하는 것이 좋다. 

## Path 영역

데이터와 로그의 저장 위치와 관련된 설정이다. 

```
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
```

path.data는 노드가 가지고 있을 문서를 저장할 경로를 설정하는 항목이다.  4장에서 본것처럼 색인이 완료된 문서들은 세그먼트에 파일로 저장되는데 이 파일이 위치하게 될 경로다. 

path.logs 영역은 ES에서 발생하는 로그를 저장할 경로로 설정하는 항목이다.

Paths 영역은 elasticsearch.yml의 기본값들 중에서 유일하게 주석처리가 없는 영역이다. 사용자가 색인한 문서와 ES에서 발생하는 애플리케이션 로그를 저장하기 위해 반드시 설정되어야 하는 값들이기 때문이다. 참고로 이 항목들이 설정되어 있지 않으면 ES가 실행되지 않는다.

path.data는 참고로 복수의 경로에 나누어서 생성이 가능하다. 
```
path.data: /var/lib/elasticsearch/data1, /var/lib/elasticsearch/data2 
```

즉 어떤 문서는 data1, 다른 문서는 data2에 저장된다. 여러개의 디스크를 가지고 있는 노드에서 이 방법으로 여러 디스크에 분산해서 자장하면 성능상 이점이 있다. 하지만 관리가 복잡해지고, 두개의 경로 중 어느 하나가 문제가 발생했을때, 어떤 문서가 영향을 받았는지 확인하기 어렵다는 문제가 있다. 

## Memory 영역

Memory 영역에는 ES 프로세스에 할당되는 메모리 영역을 어떻게 관리할 것인지 간략하게 설정할 수 있다. 

bootstrap.memory_lock: true 는 시스템의 스왑 메모리 영역을 사용하지 않도록 하는 설정이다. ES는 최대한 스왑 메모리 영역을 사용하지 않도록 권고하고 있다. 

이 설정으로 스왑 영역을 사용하지 않으면 성능을  보장할 수 있지만, 시스템의 메모리가 부족한 경우에는 OutOfMemory 에러를 일으켜 노드의 장애로 이어질 수 있다. 

대부분의 경우는 문제 없지만, JVM 힙 메모리의 용량이 시스템 메모리 용량의 절반 이상이 된다면 OOM 에러가 발생할 수 있기 때문에 조심해야 한다. 

### limits.conf

이 옵션을 사용하려면 elasticsearch.yml 뿐만아니라 OS의 /etc/security/limits.conf 파일도 수정해야 한다. 

```
elasticsearch soft memlock unlimited
elasticsearch hard memlock unlimited
```

elasticsearch soft memlock unlimited과 같이 memlock 항목은 항상 unlimited로 되어야 한다. 맨 앞에 elasticsearch는 ES 프로세스를 실행시키는 계정의 이름이다. 

1장에서 봤던 yum이나 rpm 같은 패키지 매니저를 이용해서 설치하면 ES 유저가 자동으로 생성된다. ES 프로세스를 elasticsearch 계정으로 실행할 수 있도록 설정한다. 

만약 다른 방식으로 설치해서 ES 프로세스를 다른 계정으로 실행한다면 elasticsearch가 아닌 계정 이름으로 변경해주면 된다. 또한 systemd로 프로세스를 시작하면 아래와 같은 설정이 추가로 필요하다. 



> Written with [StackEdit](https://stackedit.io/).
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTEzNDk3ODQ1MzIsLTc0NTQ4MTI1LDE2MD
EyOTMyNzEsNjM1NjY3MjU3LC0xODUyNjY0MDM0LC04MTUzMjkw
NTUsLTg5NzgyMDk1MywtMTA1MTcyNjA4NywxMjU5NjI5NDE5LD
c1MTg2NDgzNSw0NTQ2OTM4ODgsLTIxMzA1MzU5NTksMTMxMzQz
OTQxOSwxMDkwNTcyMDYyLC0xMDY5NDY0NzAwXX0=
-->