# Overview

이번 장에서는 ES를 구성하는 기본 개념들에 대해서 정리해보겠다. 

* 클러스터와 노드의 의미
* 인덱스와 타입의 의미
* 샤드와 세그먼트의 의미
* 매핑의 역할과 의미

# 클러스터와 노드의 개념

먼저 클러스터와 노드에 대해서 살펴보자. 클러스터란 여러 대의 컴퓨터 혹은 구성요소들을 논리적으로 결합하여 전체를 하나의 컴퓨터 혹은 하나의 구성요소처럼 사용할 수 있게 해주는 기술이다. 마찬가지로 ElasticSearch 클러스터 역시 여러 개의 ES 프로세스들을 논리적으로 결합하여 하나의 ES 프로세스처럼 사용할 수 있게 해준다.

이러한 클러스터를 구성하는 하나하나의 ES 프로세스를 노드라고 부른다. 즉, 여러 개의 ES 노드들을 마치 하나의 ES로 동작하게 하는 것이 ES 클러스터라고 할 수 있다. 

클러스터는 하나 이상의 노드로 구성된다. 클러스터가 3개의 노드로 구성되어 있다고 하자. 3개의 노드가 마치 하나의 ES처럼 동작하기 때문에 사실 3개의 노드 중 어떤 노드에 API를 요청해도 동일한 응답과 동작을 보장받는다. 

클러스터가 단일 노드로 구성된 경우에도 클러스터처럼 동작하기 때문에 정상적인 응답과 동작을 기대할 수 있다.

다수의 노드로 구성된 ES 클러스터는 고유의 클러스터 이름과 UUID(Universally Unique Identifier)를 가진다. 그리고 이 두 가지 고유한 속성을 통해 클러스터 내에 속한 노드들이 서로 동일한 클러스터 내에 있음을 인식하고 클러스터링 된다. 


curl 명령을 통해서 각각의 노드에서 해당 노드가 속한 클러스터의 정보를 확인할 수 있다. 

```
curl localhost:9200
{
	"name" : "elasticsearch",
	"cluster_name" : "my-elasticsearch",
	"cluster_uuid" : "680Dns66Rpkencwewe",
	"version" : {
		...
	},
	...
}
```

name은 클러스터에 속한 노드들 중 현재 요청에 응답한 노드의 이름이다. 클러스터가 다수의 노드로 구성된다면 노드별로 name값은 달라질 수 있다. 현재는 단일 노드이다. 

cluster_name은 클러스터의 이름이다. 클러스터에 속한 모든 노드들은 클러스터 이름이 같다. 새로운 노드를 클러스터에 추가하기 위해선 반드시 같은 클러스터 이름을 사용해야 한다. 만약 이름이 다른 노드가 클러스터에 합류하려고 하면 에러가 발생한다. 

cluster_uuid는 클러스터의 UUID이다. 이 값 역시 클러스터에 속한 모든 노드가 동일한 값을 가진다. 이 값은 클러스터가 최초 생성될때 자등으로 생성되는 것으로 사용자가 정하는 값은 아니다.

## 노드의 역할

노드는 클러스터를 구성하는 논리적인 ES 프로세스 하나를 의미한다. 노드도 클러스터와 마찬가지로 각각의 고유한 노드 이름과 UUID가 있고, 역할에 따라 여러 가지 노드로 구분할 수 있다. 


| 노드역할| 설명 |
|--|--|
| 마스터  | 클러스터 구성에서 중심이 되는 노드. 클러스터의 상태 등 메타데이터를 관리한다.|
| 데이터  | 사용자의 문서를 실제로 저장하는 노드 |
| 인제스트 | 사용자의 문서가 저장되기 전 문서 내용을 사전 처리하는 노드|
| 코디네이트 | 사용자의 요청을 데이터 노드로 전달하고, 다시 데이터 노드로부터 결과를 취합하는 노드|

노드가 가질 수 있는 역할은 총 4가지 이며, 각각 하나의 역할만을 하는게 아니라 한번에 여러 역할을 겸할 수 있다. 각각의 역할을 좀더 자세히 알아보자. 

### 마스터

마스터 노드는 클러스터의 메타 데이터를 관리하는 역할을 한다. 그리고 클러스터내에서 반드시 한대 이상이 있어야 한다. 

클러스터 안의 모든 노드는 현재 노드의 상태, 성능 정보, 자신이 가지고 있는 샤드의 정보를 마스터 노드에 알린다. 마스터 노드를 이런 정보를 수집하고 관리하면서 클러스터의 안정성 확보를 위한 작업을 수행한다. 

### 데이터 노드 

데이터 노드는 사용자가 색인한 문서를 저장하고, 검색 요청을 처리하여 결과를 반환하는 역할을 한다. 

상황에 따라 자신이 받은 요청 중 자신이 처리할 수 있는 요청은 직접 처리하고, 다른 데이터 노드들이 처리해야할 요청은 해당 데이터 노드에 전달한다. 

이때 어떤 노드로 요청을 전달할 것인지는 마스터 노드를 통해 받은 클러스터의 전체 상태 정보를 바탕으로 한다. 

### 인제스트 노드

인제스트 노드는 사용자가 색인하길 원하는 문서와 내용 중 변환이 필요한 부분을 사전에 처리한다. 데이터 노드에 저장하기 전에 특정 필드의 값을 가공해야 할 경우 유용하게 동작한다. 

(인제스트는 섭취하다. 받아들이다라는 뜻을 가진다.)

### 코디네이트 노드

코디네이트 노드는 실제 데이터를 저장하고 처리하지는 않지만, 사용자의 색인이나 검색 등 모든 요청을 데이터 노드에 전달하는 전달자 역할을 한다. 문서를 저장하지 않는 데이터 노드라고 생각할 수도 있다.

## 유의사항

클러스터 내에서 메타 데이터를 관리하는 마스터 노드는 반드시 한대다. 마스터 노드는 마스터의 역할이 가능한 노드와 실제 마스터 역하을 하는 노드 두 가지를 모두 통칭하는 말이다. 

만약 클러스터 구축시 3대의 마스터 노드로 구성한다면 그 중 실제론 한 대만 실제 메타데이터를 관리하는 역할을 수행한다. 나머지는 현재 동작하고 있는 마스터 노드에 장애가 발생했을때 새로운 마스터가 될 수 있는 마스터 후보 노드가 된다. 

마스터 후보 노드들은 마스터 노드들로 부터 지속적으로 클러스터 운영을 위한 데이터를 전달받기 때문에 항상 같은 메타 데이터를 유지한다. 그래서 마스터 노드에 장애가 발생하여 새로운 마스터 노드가 되도 중단 없이 서비스를 이어갈 수 있다. 

위에서도 언급했지만 각 노드들은 하나의 노드 역할만 수행하는게 아니라 동시에 다양한 역할을 수행할 수 있다. 

예를 들어, 한 노드에 아래와 같이 다양한 동시에 부여할 수 있다.
노드1 : 마스터 + 코디네이터
노드2 : 데이터 + 인제스트 + 코디네이트 

# 인덱스와 타입 



 




> Written with [StackEdit](https://stackedit.io/).
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTE0Njk0Mzg3MjYsMTE1MzYzODEzMywtMT
Q5ODcwNjg3NiwtNjkxNzc0Nzg4LC0xODU1MjEzMjk2LC0xNzc3
ODU3MTE1LDIxMzc1NzczMCwtMTQ5MjU1MTU4MywtMjA4MzEwOT
E2OCwxOTg3MDMwMDcyLC0xMTU1MzI2MTk2XX0=
-->