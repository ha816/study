# DevOps 친화적인 앱의 중요성

모든 소프트웨어는 세 가지 관점에서 볼 수 있습니다. 각 관점은 시스템과 상호작용하는 사용자들의 요구사항을 보여줍니다.

소프트웨어 시스템을 운영 측면에서 보면, 데브 옵스 구성원이 운영 환경의 시스템을 지원/유지 보수하는 것이 쉽다면 그 시스템을 DevOps 친화적이라고 표현합니다. 

DevOps한 시스템은 시스템의 상태 점검 및 운영 지표를 제공하고 성능을 측정할 수 있는 방법을 가져야 하며, 서로 다른 컴포넌트를 유연하게 업데이트할 수 있어야 한다는 의미입니다. 

오늘날의 마이크로 서비스 아키텍처는 범용 소프트웨어 개발 기술이기 때문에 클라우드에 배포할 수 있도록 적절한 모니터링 기능을 갖춰야 합니다. 제대로 된 모니터링 인프라가 없다면 소프트웨어는 운영환경에서 며칠이상 생존할 수 없을 것 입니다. 

클라우드 환경에 애플리케이션을 배포할 수 있게 되면서 복잡한 소프트웨어 설계도 쉽게 적용 가능한 인프라를 제공하게 되고, 이로 인해 소프트웨어 설치 및 운영 프로세스가 단순화되고 누구나 쉽게 소프트웨어를 설치하고 운영할 수 있게 되었습니다. 

Iaas, PaaS 및 쿠버네티스와 같은 컨테이너 관리 시스템은 OS 및 네트워크 구성, 파일 백업, 메트릭 수집과 관련된 많은 골칫 거리를 제거했으며, 자동 확장을 비롯해 많은 기능을 제공합니다. 그러나 이러한 외부 서비스 및 기술을 사용하면 비즈니스 응용 프로그램이 가지는 서비스 품질이 외부 요인에 의존해 조직 스스로 결정하지 못하게 됩니다. 게다가 클라우드 공급자는 설치된 시스템이 수행하는 작업에 따라 리소스가 효율적으로 사용되는지 확약 할 수 없습니다. 이러한 책임은 여전히 개발자와 데브옵스 팀에 달려 있습니다. 

## 운영을 효율적으로 하기 위해 고려할 사항

성공적인 운영을 위해선 아래 사항을 만족하는 기법들이 모두 필요합니다. 그게 아니더라도 운영팀에서는 모든 것을 원하게 됩니다. 다행스럽게도 스프링에서는 스프링 부트 actuator를 제공합니다. 스프링 부트 actuator를 사용하면 일반적인 서블릿 기반 애플리케이션에 대해 쉽게 적용할 수 있고 리소스도 많습니다. 하지만 리액티브의 경우 아직 보편적인 기술이 아니다보니 기법을 사용하는데 코드를 수정하거나 전혀 다른 접근법이 필요 할 수 도 있습니다. 

그렇지만 리액티브로 구현된 서비스를 운영하는 것이 일반적인 서블릿 기반의 동기식 서비스를 운영하는 것과 다르지 않아야 합니다. 서비스 운영은 12팩터 앱방법론을 따라야 하고 데브옵스 친화적이어야 하며 운영 및 개선이 쉬워야 합니다. 

### 서비스 식별

서비스 식별은 마이크로서비스 아키텍처의 필수 요소 입니다. 대부분 쿠버네티스와 같은 오케스트레이션 시스템이 여러 노드에 서비스 인스턴스를 생성하고 클라이언트 수요 증감에 따라 노드의 개수를 늘리거나 줄이기 때문에 반드시 필요합니다. 

컨테이너 실행 가능한 JAR파일은 일반적으로 의미 있는 이름을 가지고 있지만, 실행 시점에 소스 코드의 서비스 이름, 종류, 버전, 빌드 시간 및 커밋 리비전 등을 식별할 수 있어야 합니다. 그로 인해 운영환경에 올바르지 않거나 버그가 있는 서비스 버전을 식별 할 수 있어야 합니다. 그로 인해 운영환경에서 올바르지 않거나 버그가 있는 서비스 버전을 찾아 내어 회귀 테스트를 통해 변경사항을 추적하고 동일한 다른 버전과의 성능 지표를 자동으로 추적/비교 할 수 있습니다.

런타임에 각 서비스를 구별할 수 있다면, 모든 서비스가 정상적으로 동작하는지도 알고 싶을 것 입니다. 또한 서비스가 비정상 도앚ㄱ한다면 서비스가 얼마나 중요하고 핵심적인 역할을 하는지 알고 싶을 것입니다. 서비스 상태 검사 엔드포인트는 때때로 오케스트레이션 시스템에서 실패한 서비스를 식별하고 서비스를 재시작하는데 사용합니다.(Resilient)

이분법적으로 정상, 비정상 두가지 상태만 있는 것은 아닙니다. 대부분 상태에서 검사에 대한 전체적인 성능 측정치를 제고앟지만, 측정치 중 일부는 중요하지 않습니다. 

전반적인 상태를 계산할때는 큐 크기, 오류율, 사용 가능한 디스크 공간 및 메모리 처리에 따라 상태가 다르게 계산 될 수 있습니다. 전반적인 상태를 계산할때는 필수 측정 항목만으로 판별하는 것이 바람직합니다. 중요치 않은 측정치를 상태 계산에 포함하게 되면 상태가 정상인지 아닌지 판단하기 어려워질 수 있습니다. 

일반적으로 상태를 체크하는 것은 해당 서비스가 요청을 받아 들일 수 있는 수준이 되는지 아닌지를 의미합니다. 이 특성은 컨테이너의 관리 시스템에서 서비스 가용성을 확인해 서비스를 재시작할지 판단하는데 결정적입니다. 

### 서비스 상태 확인

서비스가 잘 동작하고 있는 상태에서도 시스템의 내부사항을 자세히 알고 싶을때가 있습니다. 훌륭한 시스템은 컴포넌트가 잘 동작할 뿐만 아니라 사용자가 예측 가능한 방식으로 작동합니다. 

시스템의 주요 메트릭에는 평균 응답시간, 오류율 및 과부하 상황에서 요청을 처리하는데 걸리는 시간 등이 있습니다. 과부하 상황에서 시스템이 어떻게 동작하는지ㅣ 이해하면 시스템을 적절히 확장할 수 있을 뿐만아니라 인프라 비용에 대한 적절한 계획을 수립할 수 있습니다. 부적절하게 병목을 야기하는 코드, 비효율적인 알고리즘 및 확장성을 제한하는 요인을 찾아 낼 수도 있습니다. 

### 운영 메트릭 모니터링

운영 메트릭은 시스템의 현재 상태에 대한 스냅샷을 제공하고 많은 가치를 제공합니다. 지속해서 수집하면 추세 및 경향성을 제공하고 가동 시간에 따른 서비스 메모리 사용량과 같은 상호 연관 관계가 있는 특성에 대해 통창력을 제공할 수 있습니다. 

통계 보고서를 만드는 것은 많은 서버 리소스를 소비하지 않지만, 시간에 따른 누적된 기록을 유지하려면 별도의 시계열 데이터베이스가 필요합니다. 이런 시계열 데이터베이스로는 Graphite, Prometheus등이 있습니다. 

시계열자료를 효율적으로 시각화 하고 긴급한 상황에서 경고 또는 알람을 설정하려면 Grafana, Zabbix와 같은 모니터링 소프트웨어가 좋습니다. 몇몇 클라우드 플랫폼은 종종 유사한 서비스를 이미 제공하고 있습니다. 

### 로그를 살펴보고 로그 수준 동적 변경

서비스 운영을 모티러링하고 장애 상황을 점검할때 데브옵스팀은 로그를 활용합니다. 요즘 모든 애플리케이션 로그는 한 위치에 저장하거나 시스템을 이용해 분석할 수 있어야 합니다. 이를 위해 자바 생태계에서는 ELK 스택(Elastic Search, LogStash, Kibana) 구성이 가장 널리 사용됩니다. 이러한 소프트웨어 스택은 수십개의 서비스를 하나의 시스템으로 취급할 수 있지만, 네트워크를 통해 로그를 전송하거나 모든 로그를 저장하는 것은 매우 비효율적입니다. 
일반적으로 INFO 레벨 이상의 로그를 저장하는 것으로 충분하고 DEBUG 또는 TRACE 레벨은 반복적인 이상이나 오류를 조사하는 경우만 일시적으로 수집합니다. 동적으로 로그 레벨을 변경하기 위해서 사용하기 번거롭지 않은 수준의 인터페이스를 제공해야 합니다. 

### 사용자 요청 또는 데이터 흐름 추적

로그가 전체 내용을 표현할 정도로 충분치 않다면 고달픈 디버깅 작업을 하기전 최후의 수단으로 소프트웨어 내부 프로세스를 추적할 수도 있습니다. 프로세스를 추적하는 작업은 최근 서버 요청에 대한 자세한 로그를 살펴보는 일, 대기시간, DB 요청, 각각의 소요시간 관련한 외부 호출등을 포함해 전체적인 구조와 흐름을 따라가는 일도 있습니다. 

이러한 추적은 요청 처리를 실시간으로 시각화 하는데 매우 유용하며 소프트웨어 성능을 향상 시키기에는 필수적입니다. 분산형 추적 시스템은 모든 요청, 메세지, 네트워크 지연, 오류등을 추적할 수 있습니다. 대표적으로 스프링 클라우드 슬루스 및 집킨이 있습니다. 

# 리액티브 스프링 애플리케이션 모니터링

스프링 프레임워크는 데브옵스에 친숙한 애플리케이션을 만드는 도구를 제공합니다. 이 도구 모음은 스프링 부트 엑추에이터라고 합니다. 스프링 부트 의존성을 하나 추가하는 것만으로 중요한 기능을 사용할 수 있습니다. 동시에 모니터링 인프라 측면에서 중요한 기본 뼈대를 제공합니다.

## Spring Boot Actuator

스프링 부트 엑추에이터는 스프링 부트 애플리케이션 운영을 위한 기능을 제공하는 스프링 부트의 서비스 프로젝트입니다. 이 프로젝트는 서비스 정보, 상태 확인, 메트릭 수집, 트래픽 추적, 데이터 베이스 상태 확인 등이 포함됩니다. 부트 엑추에이터의 핵심 아이디어는 애플리케이션 운영에 필요한 필수 메트릭을 제공하고 확장을 쉽게 할 수 있도록 도와주는 것 입니다. 

부트 엑추에이터는 HTTP 엔드 포인트와 JMX 빈을 이용해 많은 운영 정보를 제공하므로 다수의 모니터링 소프트웨어와 완벽한 통합이 가능합니다. 

HTTP 엔드포인트란 

기본적으로 액추에이터는 /actuator URL이하의 엔드포인트를 사용하지만 변경할 수도 있습니다. 



웹 서비스의 엔드포인트란 클라이언트 애플리케이션에서 접근 가능한 서비스 인터페이스를 말합니다. 

![](https://media.vlpt.us/images/djaxornwkd12/post/a5678630-7abd-46e2-a66c-aae4044da531/image.png)


### info 엔드포인트

기본적으로 스프링 엑추에이터는 시간에 따라 시스템 모니터링, 확장 및 개선에 필요한 중요정보를 제공합니다. 애플리케이션 설정에 의해 달라질수도 있지만, 실행 파일에 대한 정보 및 Git 정보를 제공합니다. 물론 필요하면 추가 정보를 더 포함할 수 도 있습니다. 

/actuator/info 엔드포인트는 애플리케이션 정보를 표시합니다. 이 엔드포인트는 기본적으로 사용하도록 설정되어 있고 managemen.endpoint.info.enabled 속성으로 활성/비활성화 할 수 있습니다. 





> Written with [StackEdit](https://stackedit.io/).
<!--stackedit_data:
eyJoaXN0b3J5IjpbMTQ2NjkxOTQxNywtMjMzNDg2MTMsLTEyNj
Y1MzE5MzQsLTE3NDEzMDI2NzEsLTExODgyNDgxMjgsLTQ0OTQ3
NzQwLDQ5Nzk3NTUxMyw1ODA4ODI5NDcsLTM1OTE5MzU4LDUyNj
c1Njc2LC00OTgxNjY2MSw4MTEwNjI3NF19
-->