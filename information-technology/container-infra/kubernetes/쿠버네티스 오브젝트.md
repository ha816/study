# Kubernetes Object

**쿠버네티스는 상태를 관리해야 하는 대상을 오브젝트로 정의합니다.** 기본으로 수십 가지 오브젝트를 제공하고 새로운 오브젝트를 추가하기가 매우 쉽기 때문에 확장성이 좋습니다. 

컨테이너 애플리케이션을 구동하기 위해 반드시 알아야할 몇 가지 중요한 오브젝트가 있습니다. 바로 Pod, 레플리카셋(Replica Set), 서비스(Service), 디플로이먼트(deployment) 입니다. 하나씩 알아봅시다.

##  Pod

포드는 컨테이너를 다루는 가장 기본 단위입니다. 포드는 1개 이상의 컨테이너로 구성된 컨테이너의 집합입니다. 즉 1개의 포드에는 다수의 컨태이너가 존재할 수 있습니다. 

하나의 **포드는 개념적으로 하나의 완전한 애플리케이션입니다.** 




 스토리지, 네트워크 속성을 가집니다. 같은 Pod에 속한 컨테이너는 스토리지와 네트워크를 공유하고 서로 localhost로 접근할 수 있습니다. 

Pod는 컨테이너 애플리케이션을 배포하기 위한 기본 단위로 사용됩니다. 

![Pod](https://subicura.com/assets/article_images/2019-05-19-kubernetes-basic-1/pod.png)

컨테이너를 하나만 사용하는 경우도 반드시 Pod으로 감싸서 관리합니다.

## ReplicaSet

![ReplicaSet](https://subicura.com/assets/article_images/2019-05-19-kubernetes-basic-1/replicaset.png)

Pod을 여러 개(한 개 이상) 복제하여 관리하는 오브젝트입니다. Pod을 생성하고 개수를 유지하려면 반드시 ReplicaSet을 사용해야 합니다. ReplicaSet은 복제할 개수, 개수를 체크할 라벨 선택자, 생성할 Pod의 설정값(템플릿)등을 가지고 있습니다. 직접적으로 ReplicaSet을 사용하기보다는 Deployment등 다른 오브젝트에 의해서 사용되는 경우가 많습니다.

## Service
네트워크와 관련된 오브젝트입니다. Pod을 외부 네트워크와 연결해주고 여러 개의 Pod을 바라보는 내부 로드 밸런서를 생성할 때 사용합니다. 내부 DNS에 서비스 이름을 도메인으로 등록하기 때문에 서비스 디스커버리 역할도 합니다.

## Volume

저장소와 관련된 오브젝트입니다. 호스트 디렉토리를 그대로 사용할 수도 있고 EBS 같은 스토리지를 동적으로 생성하여 사용할 수도 있습니다. 사실상 인기 있는 대부분의 저장 방식을  [지원](https://kubernetes.io/docs/concepts/storage/#types-of-volumes)합니다.

# Object Spec - YAML

```yaml
apiVersion: v1
kind: Pod
metadata:
    name: example
spec:
    containers:
    - name: busybox
        image: busybox:1.25
```


오브젝트의 명세Spec는 YAML 파일로 정의하고 여기에 오브젝트의 종류와 원하는 상태를 입력합니다. 이러한 명세는 생성, 조회, 삭제로 관리할 수 있기 때문에 REST API로 쉽게 노출할 수 있습니다. 접근 권한 설정도 같은 개념을 적용하여 누가 어떤 오브젝트에 어떤 요청을 할 수 있는지 정의할 수 있습니다. 

#  Service

쿠버네티스 파드들은 언젠가는 죽게된다. 실제 파드들은  생명주기를 갖습니다. 
워커 노드가 죽으면, 노드 상에서 동작하는 모든 파드들 또한 사라집니다.

레플리카셋(ReplicaSet)은 애플리케이션이 지속적으로 동작할 수 있도록 새로운 파드들의 생성을 통해 동적으로 클러스터를 미리 지정해 둔 상태로 되돌려 줄 수도 있습니다. 

**쿠버네티스의 서비스**는 **어떤 논리적인 파드 셋과 그 파드들에 접근할 수 있는 정책을 정의하는 추상적 개념**입니다. 서비스는 종속적인 파드들 사이를 느슨하게 결합되도록 해줍니다. 서비스는 모든 쿠버네티스 오브젝트들과 같이 YAML 이용하여 정의합니다. 서비스가 대상으로 하는 파드 셋은 보통  LabelSelector_에 의해 결정됩니다. 

비록 각 파드들이 고유의 IP를 갖고 있기는 하지만, 그 IP들은 서비스의 도움없이 클러스터 외부로 노출될 수 없습니다. 서비스들은 여러분의 애플리케이션들에게 트래픽이 실릴 수 있도록 허용합니다. 서비스들은 ServiceSpec에서  `type`을 지정함으로써 다양한 방식들로 노출을 지원합니다.

-   _ClusterIP_  (기본값) - 클러스터 내에서 내부 IP 에 대해 서비스를 노출해준다. 이 방식은 오직 클러스터 내에서만 서비스가 접근될 수 있도록 해준다.
-   _NodePort_  - NAT가 이용되는 클러스터 내에서 각각 선택된 노드들의 동일한 포트에 서비스를 노출시켜준다.  `<NodeIP>:<NodePort>`를 이용하여 클러스터 외부로부터 서비스가 접근할 수 있도록 해준다. ClusterIP의 상위 집합이다.
-   _LoadBalancer_  - (지원 가능한 경우) 기존 클라우드에서 외부용 로드밸런서를 생성하고 서비스에 고정된 공인 IP를 할당해준다. NodePort의 상위 집합이다.
-   _ExternalName_  - 이름으로 CNAME 레코드를 반환함으로써 임의의 이름(스펙에서  `externalName`으로 명시)을 이용하여 서비스를 노출시켜준다. 프록시는 사용되지 않는다. 이 방식은  `kube-dns`  버전 1.7 이상에서 지원 가능하다.

 
# Service & label

![](https://d33wubrfki0l68.cloudfront.net/cc38b0f3c0fd94e66495e3a4198f2096cdecd3d5/ace10/docs/tutorials/kubernetes-basics/public/images/module_04_services.svg)

Pod는 서로 독립적인 IP주소를 가집니다. 그리고 서비스는 다수의 IP주소를 묶어 하나의 논리적인 서비스 IP주소를 만들 수 있습니다. 그리고 하나로 묶인 파드 셋에 걸쳐서 트래픽을 라우팅하게 됩니다.   

![](https://d33wubrfki0l68.cloudfront.net/b964c59cdc1979dd4e1904c25f43745564ef6bee/f3351/docs/tutorials/kubernetes-basics/public/images/module_04_labels.svg)
레이블과 셀렉터는 쿠버네티스의 인스턴스들에 대해 논리적인 기본 그룹핑 단위입니다.
레이블은 오브젝트의 생성 시점 또는 이후 시점에 붙여질 수 있고 언제든지 수정이 가능합니다.
레이블은 오브젝트들에 붙여진 키/밸류 쌍으로 다양한 방식으로 이용 가능합니다.
```yaml
#Label Selector 
s:app=A, s:app=B
#Label
app=A, app=B
```

# Service 정의

쿠버네티스의 서비스는 Pod와 같은 쿠버네티스 인스턴스지만 비슷한 REST 오브젝트 처럼 취급되기도 합니다. 다른 REST 오브젝트와 마찬가지로, 서비스 정의를 API 서버에  `POST`하여 새 인스턴스를 생성할 수 있습니다. 

예를 들어, 각각 TCP 포트 9376에서 수신하고  `app=MyApp`  레이블을 가지고 있는 Pod 세트가 있다고 가정합시다.

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  selector:
    app: MyApp # LabelSelector는 app=MyApp 레이블을 가지는 Pod를 대상으로 한다.
  ports:
    - protocol: TCP
      port: 80 # 수신포트
      targetPort: 9376 #타깃포트

```

이 명세는 “my-service”라는 새로운 서비스 오브젝트를 생성하고,  `app=MyApp`  레이블을 가진 Pod의 TCP 9376 포트를 대상으로 합니다.

쿠버네티스는 이 서비스에 서비스 프록시가 사용하는 IP 주소 ("cluster IP")를 할당합니다. 
서비스 셀렉터의 컨트롤러는 셀렉터와 일치하는 Pod를 지속적으로 검색하고, “my-service”라는 엔드포인트 오브젝트에 대한 모든 업데이트를 POST한다.

> 참고로 서비스는  모든 수신  `port`를  `targetPort`에 매핑할 수 있다. 기본적으로 `targetPort`는  `port`  필드와 같은 값으로 설정됩니다.

클라이언트를 수정하지 않은채로, 백엔드 소프트웨어의 다음 버전에서 Pod의 타깃 포트 번호를 변경할 수도 있습니다. 

서비스의 기본 프로토콜은 TCP입니다. 다른  [지원되는 프로토콜](https://kubernetes.io/ko/docs/concepts/services-networking/service/#protocol-support)을 사용할 수도 있습니다.

많은 서비스가 하나 이상의 포트를 노출해야 하기 때문에, 쿠버네티스는 서비스 오브젝트에서 다중 포트 정의를 지원한다. 각 포트는 동일한  `프로토콜`  또는 다른 프로토콜로 정의될 수 있습니다.


> Written with [StackEdit](https://stackedit.io/).
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTk3MzgyNzI5Miw0OTg5NDAwODRdfQ==
-->