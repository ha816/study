#  Service

쿠버네티스 파드들은 언젠가는 죽게된다. 실제 파드들은  생명주기를 갖습니다. 
워커 노드가 죽으면, 노드 상에서 동작하는 모든 파드들 또한 사라집니다.

레플리카셋(ReplicaSet)은 애플리케이션이 지속적으로 동작할 수 있도록 새로운 파드들의 생성을 통해 동적으로 클러스터를 미리 지정해 둔 상태로 되돌려 줄 수도 있습니다. 

하나의 예로, 3개의 복제본을 갖는 이미지 처리용 백엔드를 고려해 봅시다. 그 복제본들은 교체 가능한 상태입니다. 그래서 프론트엔드 시스템은 하나의 Pod가 소멸되어 재생성이 되더라도, 백엔드 복제본들에 의한 영향을 받아서는 안된다. 즉, 동일 노드 상의 파드들이라 할지라도, 쿠버네티스 클러스터 내 각 파드는 유일한 IP 주소를 가지며, 여러분의 애플리케이션들이 지속적으로 기능할 수 있도록 파드들 속에서 발생하는 변화에 대해 자동으로 조정해 줄 방법이 있어야 합니다.

**쿠버네티스의 서비스**는 **어떤 논리적인 파드 셋과 그 파드들에 접근할 수 있는 정책을 정의하는 추상적 개념**입니다. 서비스는 종속적인 파드들 사이를 느슨하게 결합되도록 해줍니다. 서비스는 모든 쿠버네티스 오브젝트들과 같이 YAML 이용하여 정의합니다. 서비스가 대상으로 하는 파드 셋은 보통  LabelSelector_에 의해 결정됩니다. 

비록 각 파드들이 고유의 IP를 갖고 있기는 하지만, 그 IP들은 서비스의 도움없이 클러스터 외부로 노출될 수 없습니다. 서비스들은 여러분의 애플리케이션들에게 트래픽이 실릴 수 있도록 허용합니다. 서비스들은 ServiceSpec에서  `type`을 지정함으로써 다양한 방식들로 노출을 지원합니다.

-   _ClusterIP_  (기본값) - 클러스터 내에서 내부 IP 에 대해 서비스를 노출해준다. 이 방식은 오직 클러스터 내에서만 서비스가 접근될 수 있도록 해준다.
-   _NodePort_  - NAT가 이용되는 클러스터 내에서 각각 선택된 노드들의 동일한 포트에 서비스를 노출시켜준다.  `<NodeIP>:<NodePort>`를 이용하여 클러스터 외부로부터 서비스가 접근할 수 있도록 해준다. ClusterIP의 상위 집합이다.
-   _LoadBalancer_  - (지원 가능한 경우) 기존 클라우드에서 외부용 로드밸런서를 생성하고 서비스에 고정된 공인 IP를 할당해준다. NodePort의 상위 집합이다.
-   _ExternalName_  - 이름으로 CNAME 레코드를 반환함으로써 임의의 이름(스펙에서  `externalName`으로 명시)을 이용하여 서비스를 노출시켜준다. 프록시는 사용되지 않는다. 이 방식은  `kube-dns`  버전 1.7 이상에서 지원 가능하다.

 
# Service & label

![](https://d33wubrfki0l68.cloudfront.net/cc38b0f3c0fd94e66495e3a4198f2096cdecd3d5/ace10/docs/tutorials/kubernetes-basics/public/images/module_04_services.svg)

Pod는 서로 독립적인 IP주소를 가집니다. 그리고 서비스는 다수의 IP주소를 묶어 하나의 논리적인 서비스 IP주소를 만들 수 있습니다. 




즉 서비스는 쿠버네티스의 객체들에 대해 논리 연산을 허용해주는 기본 그룹핑 단위인,  [레이블과 셀렉터](https://kubernetes.io/ko/docs/concepts/overview/working-with-objects/labels)를 이용하여 파드 셋과 매치시킨다. 레이블은 오브젝트들에 붙여진 키/밸류 쌍으로 다양한 방식으로 이용 가능하다:

-   개발, 테스트, 그리고 상용환경에 대한 객체들의 지정
-   임베디드된 버전 태그들
-   태그들을 이용하는 객체들에 대한 분류

  

![](https://d33wubrfki0l68.cloudfront.net/b964c59cdc1979dd4e1904c25f43745564ef6bee/f3351/docs/tutorials/kubernetes-basics/public/images/module_04_labels.svg)
레이블과 셀렉터는 쿠버네티스의 인스턴스들에 대해 논리적인 기본 그룹핑 단위입니다.
레이블은 오브젝트의 생성 시점 또는 이후 시점에 붙여질 수 있고 언제든지 수정이 가능합니다.
```
s:a`pp=A


### 클라우드-네이티브 서비스 디스커버리[](https://kubernetes.io/ko/docs/concepts/services-networking/service/#%ED%81%B4%EB%9D%BC%EC%9A%B0%EB%93%9C-%EB%84%A4%EC%9D%B4%ED%8B%B0%EB%B8%8C-%EC%84%9C%EB%B9%84%EC%8A%A4-%EB%94%94%EC%8A%A4%EC%BB%A4%EB%B2%84%EB%A6%AC)

애플리케이션에서 서비스 디스커버리를 위해 쿠버네티스 API를 사용할 수 있는 경우, 서비스 내 파드 세트가 변경될 때마다 업데이트되는 엔드포인트를  [API 서버](https://kubernetes.io/docs/reference/generated/kube-apiserver/)에 질의할 수 ​​있다.

네이티브 애플리케이션이 아닌 (non-native applications) 경우, 쿠버네티스는 애플리케이션과 백엔드 파드 사이에 네트워크 포트 또는 로드 밸런서를 배치할 수 있는 방법을 제공한다.

## 서비스 정의[](https://kubernetes.io/ko/docs/concepts/services-networking/service/#%EC%84%9C%EB%B9%84%EC%8A%A4-%EC%A0%95%EC%9D%98)

쿠버네티스의 서비스는 파드와 비슷한 REST 오브젝트이다. 모든 REST 오브젝트와 마찬가지로, 서비스 정의를 API 서버에  `POST`하여 새 인스턴스를 생성할 수 있다. 서비스 오브젝트의 이름은 유효한  [DNS 서브도메인 이름](https://kubernetes.io/ko/docs/concepts/overview/working-with-objects/names/#dns-%EC%84%9C%EB%B8%8C%EB%8F%84%EB%A9%94%EC%9D%B8-%EC%9D%B4%EB%A6%84)이어야 한다.

예를 들어, 각각 TCP 포트 9376에서 수신하고  `app=MyApp`  레이블을 가지고 있는 파드 세트가 있다고 가정해 보자.

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  selector:
    app: MyApp
  ports:
    - protocol: TCP
      port: 80
      targetPort: 9376

```

이 명세는 “my-service”라는 새로운 서비스 오브젝트를 생성하고,  `app=MyApp`  레이블을 가진 파드의 TCP 9376 포트를 대상으로 한다.

쿠버네티스는 이 서비스에 서비스 프록시가 사용하는 IP 주소 ("cluster IP"라고도 함) 를 할당한다. (이하  [가상 IP와 서비스 프록시](https://kubernetes.io/ko/docs/concepts/services-networking/service/#%EA%B0%80%EC%83%81-ip%EC%99%80-%EC%84%9C%EB%B9%84%EC%8A%A4-%ED%94%84%EB%A1%9D%EC%8B%9C)  참고)

서비스 셀렉터의 컨트롤러는 셀렉터와 일치하는 파드를 지속적으로 검색하고, “my-service”라는 엔드포인트 오브젝트에 대한 모든 업데이트를 POST한다.

> **참고:**  서비스는  _모든_  수신  `port`를  `targetPort`에 매핑할 수 있다. 기본적으로 그리고 편의상,  `targetPort`는  `port`  필드와 같은 값으로 설정된다.

파드의 포트 정의에는 이름이 있고, 서비스의  `targetPort`  속성에서 이 이름을 참조할 수 있다. 이것은 다른 포트 번호를 통한 가용한 동일 네트워크 프로토콜이 있고, 단일 구성 이름을 사용하는 서비스 내에 혼합된 파드가 존재해도 가능하다. 이를 통해 서비스를 배포하고 진전시키는데 많은 유연성을 제공한다. 예를 들어, 클라이언트를 망가뜨리지 않고, 백엔드 소프트웨어의 다음 버전에서 파드가 노출시키는 포트 번호를 변경할 수 있다.

서비스의 기본 프로토콜은 TCP이다. 다른  [지원되는 프로토콜](https://kubernetes.io/ko/docs/concepts/services-networking/service/#protocol-support)을 사용할 수도 있다.

많은 서비스가 하나 이상의 포트를 노출해야 하기 때문에, 쿠버네티스는 서비스 오브젝트에서 다중 포트 정의를 지원한다. 각 포트는 동일한  `프로토콜`  또는 다른 프로토콜로 정의될 수 있다.




> Written with [StackEdit](https://stackedit.io/).
<!--stackedit_data:
eyJoaXN0b3J5IjpbMjAyNDYxMzA1MywtMTUwOTU2ODg5LC04Mj
c5NzA5NDIsMTkzOTY5ODY5NCwtMTIzMTU2NTQyNiwzMTc3MDE3
MzMsNzMwOTk4MTE2XX0=
-->