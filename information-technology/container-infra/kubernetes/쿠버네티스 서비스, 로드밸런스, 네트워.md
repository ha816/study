#  Service

쿠버네티스 파드들은 언젠가는 죽게된다. 실제 파드들은  생명주기를 갖습니다. 
워커 노드가 죽으면, 노드 상에서 동작하는 모든 파드들 또한 사라집니다.

레플리카셋(ReplicaSet)은 애플리케이션이 지속적으로 동작할 수 있도록 새로운 파드들의 생성을 통해 동적으로 클러스터를 미리 지정해 둔 상태로 되돌려 줄 수도 있습니다. 

**쿠버네티스의 서비스**는 **어떤 논리적인 파드 셋과 그 파드들에 접근할 수 있는 정책을 정의하는 추상적 개념**입니다. 서비스는 종속적인 파드들 사이를 느슨하게 결합되도록 해줍니다. 서비스는 모든 쿠버네티스 오브젝트들과 같이 YAML 이용하여 정의합니다. 서비스가 대상으로 하는 파드 셋은 보통  LabelSelector_에 의해 결정됩니다. 

비록 각 파드들이 고유의 IP를 갖고 있기는 하지만, 그 IP들은 서비스의 도움없이 클러스터 외부로 노출될 수 없습니다. 서비스들은 여러분의 애플리케이션들에게 트래픽이 실릴 수 있도록 허용합니다. 서비스들은 ServiceSpec에서  `type`을 지정함으로써 다양한 방식들로 노출을 지원합니다.

-   _ClusterIP_  (기본값) - 클러스터 내에서 내부 IP 에 대해 서비스를 노출해준다. 이 방식은 오직 클러스터 내에서만 서비스가 접근될 수 있도록 해준다.
-   _NodePort_  - NAT가 이용되는 클러스터 내에서 각각 선택된 노드들의 동일한 포트에 서비스를 노출시켜준다.  `<NodeIP>:<NodePort>`를 이용하여 클러스터 외부로부터 서비스가 접근할 수 있도록 해준다. ClusterIP의 상위 집합이다.
-   _LoadBalancer_  - (지원 가능한 경우) 기존 클라우드에서 외부용 로드밸런서를 생성하고 서비스에 고정된 공인 IP를 할당해준다. NodePort의 상위 집합이다.
-   _ExternalName_  - 이름으로 CNAME 레코드를 반환함으로써 임의의 이름(스펙에서  `externalName`으로 명시)을 이용하여 서비스를 노출시켜준다. 프록시는 사용되지 않는다. 이 방식은  `kube-dns`  버전 1.7 이상에서 지원 가능하다.

 
# Service & label

![](https://d33wubrfki0l68.cloudfront.net/cc38b0f3c0fd94e66495e3a4198f2096cdecd3d5/ace10/docs/tutorials/kubernetes-basics/public/images/module_04_services.svg)

Pod는 서로 독립적인 IP주소를 가집니다. 그리고 서비스는 다수의 IP주소를 묶어 하나의 논리적인 서비스 IP주소를 만들 수 있습니다. 그리고 하나로 묶인 파드 셋에 걸쳐서 트래픽을 라우팅하게 됩니다.   

![](https://d33wubrfki0l68.cloudfront.net/b964c59cdc1979dd4e1904c25f43745564ef6bee/f3351/docs/tutorials/kubernetes-basics/public/images/module_04_labels.svg)
레이블과 셀렉터는 쿠버네티스의 인스턴스들에 대해 논리적인 기본 그룹핑 단위입니다.
레이블은 오브젝트의 생성 시점 또는 이후 시점에 붙여질 수 있고 언제든지 수정이 가능합니다.
레이블은 오브젝트들에 붙여진 키/밸류 쌍으로 다양한 방식으로 이용 가능합니다.
```yaml
#Label Selector 
s:app=A, s:app=B
#Label
app=A, app=B
```

# Service 정의

쿠버네티스의 서비스는 Pod와 같은 쿠버네티스 인스턴스지만 비슷한 REST 오브젝트 처럼 취급되기도 합니다. 다른 REST 오브젝트와 마찬가지로, 서비스 정의를 API 서버에  `POST`하여 새 인스턴스를 생성할 수 있습니다. 

예를 들어, 각각 TCP 포트 9376에서 수신하고  `app=MyApp`  레이블을 가지고 있는 Pod 세트가 있다고 가정합시다.

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  selector:
    app: MyApp # LabelSelector는 app=MyApp 레이블을 가지는 Pod를 대상으로 한다.
  ports:
    - protocol: TCP
      port: 80 # 수신포트
      targetPort: 9376

```

이 명세는 “my-service”라는 새로운 서비스 오브젝트를 생성하고,  `app=MyApp`  레이블을 가진 Pod의 TCP 9376 포트를 대상으로 합니다.

쿠버네티스는 이 서비스에 서비스 프록시가 사용하는 IP 주소 ("cluster IP")를 할당합니다. 
서비스 셀렉터의 컨트롤러는 셀렉터와 일치하는 Pod를 지속적으로 검색하고, “my-service”라는 엔드포인트 오브젝트에 대한 모든 업데이트를 POST한다.

> 참고로 서비스는  모든 수신  `port`를  `targetPort`에 매핑할 수 있다. 기본적으로 `targetPort`는  `port`  필드와 같은 값으로 설정됩니다.

클라이언트를 수정하지 않은채로, 백엔드 소프트웨어의 다음 버전에서 Pod가 노출시키는 포트 번호를 변경할 수 있다.

서비스의 기본 프로토콜은 TCP이다. 다른  [지원되는 프로토콜](https://kubernetes.io/ko/docs/concepts/services-networking/service/#protocol-support)을 사용할 수도 있다.

많은 서비스가 하나 이상의 포트를 노출해야 하기 때문에, 쿠버네티스는 서비스 오브젝트에서 다중 포트 정의를 지원한다. 각 포트는 동일한  `프로토콜`  또는 다른 프로토콜로 정의될 수 있다.




> Written with [StackEdit](https://stackedit.io/).
<!--stackedit_data:
eyJoaXN0b3J5IjpbMTU4OTc5NzMzMSwtMTYyOTU3NzgsLTE1MD
k1Njg4OSwtODI3OTcwOTQyLDE5Mzk2OTg2OTQsLTEyMzE1NjU0
MjYsMzE3NzAxNzMzLDczMDk5ODExNl19
-->