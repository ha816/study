# Overview

엘라스틱 서치는 인덱스에 저장된 문서를 검색하도록 다양한 검색 기능을 제공한다. 특정 문장이 검색어로 요청되면 분석기를 통해 분석된 토큰의 일치 여부를 판단해서 그 결과에 점수(score)를 매긴다. 이를 기반으로 순서를 적용해 결과를 사용자에게 최종적으로 출력하게 된다. 

검색의 대상이 되는 필드는 분석이 되는 Text 타입의 유형이 될 수도 있고 분석이 되지 않는 Keyword 타입의 유형이 될수도 있다. 

엘라스틱 서치에서는 다양한 검색 조건을 만족하기 위해 QueryDSL이라는 특수한 쿼리 문법을 제공한다. 

# 검색 API

문장은 색인 시점에 term(텀)으로 분해된다. 토크나이저가 나눈 토큰을 토큰 필터로 처리하고 나면 그것이 바로 term이다. 

엘라스틱서치는 색인 시점에 분석기로 분석된 텀을 역색인 구조로 만들어 내부적으로 저장한다. 검색 시점에는 Keyword 타입과 같은 분석이 불가능한 데이터와 Text 타입과 같은 분석이 가능한 데이터를 구분해서 가능할 경우 분석기로 분석을 수행한다. 

검색 API는 기본적으로 질의(Query)를 기반으로 동작한다. 검색 질의에는 검색하고자 하는 각종 조건들을 명시할 수 있으며 동일한 조건을 URI, Request Body 검색 두 가지로 할 수 있다. 

URI 방법은 루씬에서 사용하는 전통적인 방식이고 Request Body는 RESTful API를 이용해 Request Body에 조건을 표시하는 방법이다. 

## URI

이 방식은 HTTP GET 요청을 활용하는 방식으로 파라미터를 key=value 형태로 전달한다. URL에 검색할 컬럼과 검색어를 직접 지정하면 검색이 수행된다. 파라미터로는 표현의 한계가 있어 복잡한 질의를 작성하는 것을 불가능하다. 그래도 웹브라우저를 통해 빠르게 테스트를 해볼 수 있다는 장점이 있다. 

|파라미터|기본값| 설명|
|--|--|--|
|q |  | 검색을 수행할 쿼리 문자열 조건을 지정한다.|
|df |  |쿼리에 검색을 수행할 필드가 지정되지 않았을 경우, 기본 값으로 검색할 필드를 지정한다|
|analyzer| 검색 새당 필드에 설정된 형태소 분석기|문자열을 형태소 분석할때 사용할 분석기를 지정한다.|
|analyzer_wildcard| false|와일드카드 검색 활성화여부를 지정한다.|
|default_operator|OR|두 개 이상의 검색 조건이 쿼리 문자열에 포함된 경우 검색 조건 연산자를 설정한다.|
|_source| true| 검색 결과에 문서 본문 포함 여부를 지정한다|
|sort|  |검색 결과의 정렬 기준필드를 지정한다|
|from|  |검색을 시작할 문서의 위치를 지정한다|
|size|  |반환할 검색 결과 갯수를 설정한다.|

q 옵션에는 기본적으로 '[필드명]:검색어' 형태로 입력할 수 있으며, 예제와 같이 여러개의 필드를 검색할때는 공백을 입력한 후 추가적인 필드명과 검색어를 입력한다. 

## Request Body 검색

이 방식에서는 HTTP 요청시 본문에 JSON 혀애로 검색 조건을 기록해서 검색을 요청한다. 간단한 검색은 언뜻 보면 URI 방식이 더 좋아 보일것이다. 하지만 JSON 형태로 작성하면 전체적인 방식이 더 잘 보일 것이다. 

# Query DSL

Query DSL로 쿼리를 작성하려면 미리 정의된 문법에 따라 JSON 구조를 작성해야 한다. 기본적인 구조는 다음과 같다.
```
{
	"size":
	"from":
	"timeout":
	
	"_source":{}
	"query":{}
	"aggs":{}
	"sort":{}
}
```
size는 리턴 받는 결과의 갯수를 지정한다. 기본값은 10이다
from은 몇 번째 문서부터 가져올지 지정한다. 기본값은 0이다.
timeoout은 검색을 요청해서 받는데 까지 걸리는 제한 시간을 나타낸다. timeout을 너무 짧게 잡으면 timeout에 걸리지 않은 문서만 결과로 나타나기 때문에 의도치 않은 결과가 나타날 수 있다. 기본값은 무한대이다. 

_source는 검색시 필요한 필드만 출력하고 싶을 때 사용한다.
query는 검색 조건문이 들어가는 공간이다.
aggs는 통계 및 집계 데이터를 사용하는 공간이다.
sort는 문서결과를 어떤 순서로 출력할지에 대한 공간이다.


```
{
	"took":
	"timed_out":
	
	"_shards":{
		"total":
		"successful":
		"failed":
	},

	"hits":{
		"total":
		"max_score":
		"hits":[]
	}
}
```

위의 JSON 형태는 기본 응답 구조이다. 
took은 쿼리 수행 시간을 나타낸다.
timed_out은 쿼리 시간이 초과할 경우 나타난다.
_shards.total은 쿼리를 요청한 저체 샤드의 개수를 나타낸다.
successful은 성공적으로 응답한 샤드의 갯수를 나타낸다.
failed는 응답에 실패한 샤드의 갯수를 나타낸다.

_hits.total은 검색어에 매칭된 문서의 전체 개수를 나타낸다. 
max_score는 일치하는 문서의 스코어 값중 가장 높은 값을 출력한다.
hits는 각 문서 정보와 스코어 값을 보여준다. 

## Query DSL 쿼리와 필터

Query DSL을 잉요해 검색 질의를 작성할 때 조금만 조건이 복잡해지더라도 여러 개의 작은 질의를 조합해서 사용해야 한다. 이때 작성되는 작은 질의들을 두 가지 형태로 나눠서 생각해 볼 수 있다. 실제 분석기에 의한 전문 분석이 필요한 경우와 단순시 필터 조건으로 검색이 가능한 경우다.

엘라스틱 서치에서 전문 분석이 필요한 질의를 쿼리 컨텍스트라고 하며 단순 필터 조건 질의는 필터 컨텍스트라 구분하여 사용한다. 

||쿼리 컨텍스트|필터 컨텍스트|
|--|--|--|
|용도|전문 검색시 사용 | 조건 검색시 사용|
|특징| 분석기에 의해 분석 수행, 연관성 관련 Score 계산, 루씬 레벨에서 분석 과정을 거쳐야 하므로 상대적으로 느림 | 단순 판별 기능, score 관련 계산 하지 않음. 상대적으로 빠름. |

대부분의 경우 쿼리 컨텍스트 방식과 필터 컨텍스트 방식 모두 같은 결과를 얻는다. 하지만 어떤 방식을 사용하느냐에 따라 검색 과정이나 성능이 크게 달라지기 대문에 가능한 용도에 맞게 사용해야 한다. 

### 쿼리 컨텍스트

* 문서가 쿼리와 얼마나 유사한지 스코어 계산을 한다.
* 질의가 요청도리때 마다 루씬을 이용해 계산을 수행하고 결과가 캐싱되지 않는다.
* 일반적으로 전문 검색에 많이 사용한다.
* 캐싱 되지 않고 디스크 연산을 하기에 상대적으로 느리다.

### 필터 컨텍스트

* 쿼리의 조건과 문서가 일치하는지 판별한다.
* 스코어 계산을 하지 않고 단순 매칭 여부를 검사한다.
* 자주 사용되는 필터 결과는 내부적으로 캐싱해둔다.
* 기본 메모리 연산을 수행하기에 빠르다.

## Query DLS의 주요 파라미터

쿼리를 작성할때 공통적으로 자주 사용되는 주요 파라미터가 무엇이 있는지 알아보도록 하자.

### Multi Index 검색

기본적으로 모든 검색 요청은 Multi Index 및 Multi Type검색이 가능하다. 이러한 특성 덕에 다수의 인덱스를 검색해야 할때도 한번의 요청으로 검색 결과를 얻을 수 있다. 검색 요청시 "," 컴마를 이용해 다수의 인덱스 명을 입력할 수 있다. 이때 지정된 모든 인덱스가 검색 대상이 된다. 

아래 쿼리는 move_search, movie_auto 인덱스를 모두 검색한다. 
```
POST movie_search, movie_auto/_search 
...
```

### 쿼리 결과 페이징

## Query DLS의 주요 쿼리

> Written with [StackEdit](https://stackedit.io/).
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTE1MDEzMTAyMTUsLTE1OTk4NzY0MjQsMz
g4MTYxNTIzLC0xOTYzNjkyNjkxLC0zMDY3ODY4MTQsMTE3NjEx
ODU2MCwyMDcxMTQ1Nzk2LDU5MzY2MzEwOF19
-->