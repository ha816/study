# Overview

엘라스틱서치가 기본적으로 분산 시스템을 지향하다보니 생소한 용어가 많다. 용어가 무엇인지 잘 파악하면 전체 아키텍처를 이해하는데 많은 도움이 될것이다. 엘라스틱서치를 구성하는 주요 구성요소로 어떤 것이 있는지 알아보자.

# Index(색인)

인덱스(색인)는 RDMBS에서 database에 해당한다. database를 만들때 비슷한 색인은 다소 비슷한 특성을 가진 문서들의 모임으로도 이해할 수 있다. 이를테면 고객 데이터에 대한 색인, 제품 카탈로그에 대한 색인, 주문 데이터에 대한 색인을 각각 둘 수 있다. 인덱스의 이름은 반드시 모두 소문자여야 하며 추가, 수정, 삭제, 검색은 RESTful API로 수행할 수 있다. 만약 인덱스가 없는 상태에서 데이터가 추가된다면 데이터를 이용해 인덱스가 자동 생성된다. 

하나의 인덱스는 하나의 타입만 가지며 하나의 물리적인 노드에 여러 개의 논리적인 인덱스를 생성할 수 있다. 검색 시 인덱스 이름으로 문서 데이터를 검색하며, 여러 개의 인덱스를 동시에 검색하는 것도 가능하다. 

엘라스틱 서치를 분산환경으로 구성하면 하나의 인덱스가 여러 노드에 분산 저장되어 관리된다. 엘라스틱 서치는 인덱스 생성시 기본적으로 5개의 프라이머리 샤드와 1개의 레플리카 샤드 세트를 생성한다. 각 샤드 수는 인덱스를 생성할때 옵션으로 변경할 수 있다. 

### 샤드

색인된 문서는 하나의 인덱스에 담긴다. 인덱스 내부에 색인된 데이터는 물리적인 공간에 여러 개의 파티션으로 나뉘어 구성되는데, 이 파티션을 엘라스틱 서치에서는 샤드(Shard)라 부른다. 엘라스틱 서치는 다수의 샤드로 문서를 분산 저장하고 있어 데이터 손실 위험을 최소화 할 수 있다. 

### 타입
타입은 인덱스의 논리적 구조를 말한다. 엘라스틱 서치 6.0이하 버전에서는 하나의 인덱스에 여러 타입을 설정이 가능했지만 6.1버전부터는 인덱스당 하나의 타입만 사용할 수 있다. 

### 문서
문서(Document)는 엘라스틱 서치에서 데이터가 저장되는 최소단위이다. 기본적으로 JSON 포맷으로 데이터가 저장된다. 문서는 데이터베이스와 비교하자면 테이블의 행을 의미한다. 
하나의 문서는 다수의 필두로 구성되어 있는데 각 필드는 데이터의 형태에 따라 용도에 맞는 데이터 타입(DataType)을 정의해야 한다. 또한 문서는 중첩 구조를 지원하기 때문에 이로 문서안에 문서를 지정하는 것도 가능하다. 

### 필드

필드(Field)는 문서를 구성하기 위한 속성이다. 일반적으로 데이터베이스의 컬럼과 비교할 수 있으니 컬럼이 정적인 데이터 타입인데 반해 필드는 좀 더 동적인 타입이다. 

하나의 필드는 목적에 따라 다수의 데이터 타입을 가질 수 있다. 영화 정보를 담아둔 문서에 제목 필드가 있다고 생각해보자. 영화 제목을 검색할때 매칭 검색을 하거나 초성을 이용한 검색이 모두 지원되도록 하려면 제목 필드는 2개의 데이터 타입을 가져야 한다. 

### 매핑
매핑은 문서의 필드와 필드 속성을 정의하고 그에 따른 색인 방법을 정의하는 프로세스다. 인덱스의 매핑 정보에는 여러가지 데이터 타입을 지정할 수 있지만 필드명은 중복해서 사용할 수 없다.

## 클러스터(Cluster)

 클러스터는 여러 노드(서버)의 집합으로 구성되며, 그림에서는 하나의 클러스터만 가정했지만, 여러 개의 클러스터를 구성할 수도 있으며, 이럴때는 클러스터의 이름으로 클러스터를 구분한다. 이 이름은 중요한데, 어떤 노드가 어느 클러스터에 포함되기 되는지를 이름으로 판별하기 때문이다. 

![enter image description here](https://img1.daumcdn.net/thumb/R800x0/?scode=mtistory2&fname=https://t1.daumcdn.net/cfile/tistory/99AB08425C9F17D928)

참고로 한 shard가 replication을 쓰는 경우, primary와 replica shard는  같은 노드에 존재할 수 없다. 

## 노드(Node)

노드는 클러스터에 포함된 단일 서버로서 데이터를 저장하고 클러스터의 색인화 및 검색 기능에 참여한다. 노드는 클러스터처럼 이름으로 식별되는데, 기본 이름은 시작 시 노드에 지정되는 임의 UUID(Universally Unique IDentifier)이다. 원한다면 기본 이름 대신 어떤 노드 이름도 정의할 수 있다. 이 이름은 관리의 목적에서 중요한데 네트워크의 어떤 서버가 Elasticsearch 클러스터의 어떤 노드에 해당하는지 식별해야 하기 때문이다.

노드 별로 분산 처리를 위해선 다양한 형태의 노드를 조합해서 클러스터를 구성해야 한다. 기본적으로 마스터 노드가 노드 추가, 삭제와 같은 전체적인 클러스터를 관리하고 데이터 노드는 데이터 검색, 색인등을 수행한다. 설정에 따라 4가지 유형의 노드가 존재한다. 

### 마스터 노드(Master Node)

마스터 노드는 노드 추가와 제거 같은 클러스터 수준의 전반적인 작업을 대표해서 처리한다. 따라서 네트워크 속도가 빠르고 지연이 없는 노드를 마스터 노드로 선정해야 한다. 다수의 노드를 마스터 노드로 설정할 수 있지만 결과적으로 하나의 노드만이 마스터 노드로 선출되어 동작한다. 

### 데이터 노드(Data Node)

데이터 노드는 문서가 실제 저장되는 노드다. 데이터가 분산 저장되는 물리적 공간인 샤드가 배치되는 노드이기도 하다. 색인 작업은 CPU, 메모리, 스토리지 같은 컴퓨팅 리로스를 많이 소모하기 때문에 리소스 모니터링이 필요하다. 

데이터 노드는 가능한 한 마스터 노드와 분리해서 구성하는 게 좋다. 단 색인할 문서가 적으면 함께 구성해도 상관은 없다. 

### 인제스트 노드(Ingest Node)
색인에 앞서 데이터 전처리를 위한 노드다. 데이터의 포맷을 변경하기 위해 스크립트로 전처리 파이프라인을 구성하고 실행할 수 있다. 

### 코디네이팅 노드(Coordinating Node)

마스터 노드, 데이터 노드, 인제스트 노드의 역할을 하지 않고 단순히 들어온 요청을 라운드 로빈 방식으로 분산시켜주는 노드다. 


# 엘라스틱서치 주요 API

 엘라스틱 서치는 RESTful 방식의 API를 제공하며, JSON 기반으로 통신한다. 기본적으로 HTTP 통신을 위해 9200번 포트를 사용한다. 

문서를 색인하기 위해서는 기본적으로 인덱스가 존재 해야 한다. 인덱스를 통해 입력되는 문서의 필드를 정의하고 각 필드에 알맞은 데이터 타입을 지정할 수 있다. 

>index vs indices 용어정리
>index: 색인 데이터
>indices: 매핑 정보를 저장하는 논리적인 데이터 공간

사실 엘라스틱 서치는 사용 편의성을 위해서 스키마리스(Schemaless)라는 기능을 제공한다. 문서를 색인하기 위해서는 기본적으로 필요한 인덱스 생성 과정 없이 문서를 추가해도 문서가 색인 되도록 지원하는 일종의 편의 기능이다. 

하지만 스키마리스는 가급적 사용하지 않도록 하자. 왜냐하면 스키마리스 사용은 성능과 밀접한 연관이 있기 때문에 특수한 상황에서만 사용해야 한다. 

## 인덱스 관리 API

인덱스 관리 API는 말 그대로 인덱스 관리를 위해 사용되는 API이다. 대표적으로는 인덱스 추가 및 삭제가 가능하다. 

### 인덱스 생성

```
--생성하려는 movie 인덱스
PUT /movie {
	"settings": {
		"number_of_shards": 3,
		"number_of_replicas": 2,
	},
	"mappings": {
		"_doc": {
			"properties" : {
				"movieCd": {"type":"integer"},
				"movieNm": {"type":"text"},
				"openDt": {"type":"date"},
				"typeNm": {"type":"keyword"},
				...
			}
		}
	}
}
```

인덱스 생성시에는 매핑이라는 세부 설정을 이용할 수 있는데, 매핑은 문서와 문서에 포함된 필드, 필드 타입 등을 세세하게 지정하는 것이 가능한 설정 방법이다. 인덱스 생성시 이러한 매핑 정보를 추가할 수 있다. 

**주의할 점은 한번 생성된 매핑 정보를 변경할 수 없다.** 만약 잘못 생성했거나 변경해야하는 경우에는 데이터를 삭제하고 다시 색인하는 수 밖에 없다. 

### 인덱스 삭제

인덱스 삭제의 경우도 주의할 점이 있다. 바로 인덱스를 삭제하면 다시는 복구할 수 없기 때문이다. 인덱스 삭제는 신중하게 하자.

##  문서 관리 API

문서 관리 API는 실제 문서를 색인하고 조회, 수정, 삭제를 지원하는 API다. 이를 이용해서 문서를 색인하고 내용을 수정하거나 삭제 할 수 있다. 엘라스틱 서치는 기본적으로 검색엔진이기 때문에 다양한 검색 패턴을 지원하는 Search API를 별도로 제공한다. 하지만 색인된 문서의 ID를 기준으로 문서를 다뤄야 할 경우는 문서 관리 API를 사용한다. 

문서 관리 API는 다음과 같은 세부 기능을 제공한다. 
* Index API
	* 한 건의 문서를 색인한다. 
* Get API
	* 한 건의 문서를 조회한다.
* Delete API
	* 한 건의 문서를 삭제한다.
* Update 
	* 한 건의 문서를 업데이트한다.

문서 관리 API는 기본적으로 한 건의 문서를 처리하기 위한 기능을 제공하며 Single document API라고도 부른다. 하지만 클러스터를 운영하다보면 다수의 문서를 처리해야 하는 경우도 종종 발생할 것이다. 이런 경우 Multi-document API도 제공한다. 

* Bulk API
	* 한 건의 문서를 색인한다. 
* Multi Get API
	* 한 건의 문서를 조회한다.
* So on...


## 검색 API

엘라스틱 검색 API의 사용방식은 크게 두 가지 방식이 있다. 

1. HTTP URI 형태의 파라미터를 URI에 추가해 검색하는 방법
2. RESTful API방식인 QueryDSL을 사용해 요청 본문(Request Body)에 질의 내용을 추가해 검색하는 법

Request Body 방식(2)은 URI 방식(1)보다 제약 사항이 적기 때문에 현업에서는 Request Body식을 선호한다. Uri 방식은 간단한 검색을 하거나 디버깅할 때 간편하게 사용하는 경우에 종종 사용된다. 

간단한 표현식이라면 두 가지 형식을 섞어서 사용하는 것도 가능하다. 예를 들어, Query를 URI 방식으로 사용하고 나머지 기능을 JSON 형태로 사용해도 된다. 

### URI 방식의 검색 질의

먼저 살펴볼 URI 방식의 검색 질의는 문서 ID인 _id값을 사용해 문서를 조회하는 방식이다. 결국 URL에 파라미터를 붙여 조회하는 식이다. 예컨데 123이라는 키를 가진 문서를 질의하려면 GET 메서드를 사용해 다음과 같이 검색할 수 있다. 

```
GET /movie/_doc/123?pretty=true
```

### Request Body 방식의 검색 질의

URI 검색 질의는 여러 필드를 각기 다른 검색어로 질의하는 것이 어렵다. 쿼리의 조건이 복잡하고 길어지기 때문이다. 이럴 때는 JSON 방식으로 질의하는게 좋다. JSON  포맷을 이용해 RESTful방식으로 질의하면 매우 복잡한 질의도 쉽게 표현할 수 있고 여러 조건을 한번에 처리할 수 있다. 사용법은 간단하다. 앞서 만든 URI 파리미터를 JSON 포맷으로 옮기기만 하면 된다.

```
POST /{index 명}/_search {
	JSON 쿼리 구문
}
```

## 집계 API

과거에는 통계작업을 위해 루씬이 제공하는 패싯(Facets) 기능을 많이 활용했다. 하지만 패싯은 디스크 기반으로 동작했고 분산환경에는 최적화가 되지 않았기 때문에 대용량 데이터의 통계 작업에는 적합하지 않았다.

엘라스틱 서치에서는 5.0이후에 패싯 방식의 통계방식을 과감히 버리고 독자적인 집계 API를 내놓았다. 집계 API는 기본적으로 메모리를 기반으로 동작하기 때문에 대용량의 데이터 통계작업이 가능해졌다. 




> Written with [StackEdit](https://stackedit.io/).
<!--stackedit_data:
eyJoaXN0b3J5IjpbMTY1NTcwOTc0XX0=
-->