# Overview

 엘라스틱 서치는 RESTful 방식의 API를 제공하며, JSON 기반으로 통신한다. 기본적으로 HTTP 통신을 위해 9200번 포트를 사용한다. 

문서를 색인하기 위해서는 기본적으로 인덱스가 존재 해야 한다. 인덱스를 통해 입력되는 문서의 필드를 정의하고 각 필드에 알맞은 데이터 타입을 지정할 수 있다. 

사실 엘라스틱 서치는 사용 편의성을 위해서 스키마리스(Schemaless) 기능을 제공한다. 스키마리스란 문서를 색인하기 위해서는 기본적으로 필요한 인덱스 생성 과정 없이 문서를 추가해도 문서가 색인 되도록 지원하는 일종의 편의 기능이다. 하지만 **스키마리스는 가급적 사용하지 않도록 하자.** 왜냐하면 스키마리스 사용은 성능과 밀접한 연관이 있기 때문에 특수한 상황에서만 사용해야 한다. 

## 인덱스 관리 API

인덱스 관리 API는 말 그대로 인덱스 관리를 위해 사용되는 API이다. 대표적으로는 인덱스 추가 및 삭제가 가능하다. 

### 인덱스 생성

```
--생성하려는 movie 인덱스
PUT /movie {
	"settings": {
		"number_of_shards": 3,
		"number_of_replicas": 2,
	},
	"mappings": {
		"_doc": {
			"properties" : {
				"movieCd": {"type":"integer"},
				"movieNm": {"type":"text"},
				"openDt": {"type":"date"},
				"typeNm": {"type":"keyword"},
				...
			}
		}
	}
}
```

인덱스 생성시에는 매핑이라는 세부 설정을 이용할 수 있는데, 매핑은 문서와 문서에 포함된 필드, 필드 타입 등을 세세하게 지정하는 것이 가능한 설정 방법이다. 인덱스 생성시 이러한 매핑 정보를 추가할 수 있다. 

**주의할 점은 한번 생성된 매핑 정보를 변경할 수 없다.** 만약 잘못 생성했거나 변경해야하는 경우에는 데이터를 삭제하고 다시 색인하는 수 밖에 없다. 

### 인덱스 삭제

인덱스 삭제의 경우도 주의할 점이 있다. 바로 인덱스를 삭제하면 다시는 복구할 수 없기 때문이다. 인덱스 삭제는 신중하게 하자.

##  문서 관리 API

문서 관리 API는 실제 문서를 색인하고 조회, 수정, 삭제를 지원하는 API다. 이를 이용해서 문서를 색인하고 내용을 수정하거나 삭제 할 수 있다. 엘라스틱 서치는 기본적으로 검색엔진이기 때문에 다양한 검색 패턴을 지원하는 Search API를 별도로 제공한다. 하지만 색인된 문서의 ID를 기준으로 문서를 다뤄야 할 경우는 문서 관리 API를 사용한다. 

문서 관리 API는 다음과 같은 세부 기능을 제공한다. 
* Index API
	* 한 건의 문서를 색인한다. 
* Get API
	* 한 건의 문서를 조회한다.
* Delete API
	* 한 건의 문서를 삭제한다.
* Update 
	* 한 건의 문서를 업데이트한다.

문서 관리 API는 기본적으로 한 건의 문서를 처리하기 위한 기능을 제공하며 Single document API라고도 부른다. 하지만 클러스터를 운영하다보면 다수의 문서를 처리해야 하는 경우도 종종 발생할 것이다. 이런 경우 Multi-document API도 제공한다. 

* Bulk API
	* 한 건의 문서를 색인한다. 
* Multi Get API
	* 한 건의 문서를 조회한다.
* So on...

## 집계 API

과거에는 통계작업을 위해 루씬이 제공하는 패싯(Facets) 기능을 많이 활용했다. 하지만 패싯은 디스크 기반으로 동작했고 분산환경에는 최적화가 되지 않았기 때문에 대용량 데이터의 통계 작업에는 적합하지 않았다.

엘라스틱 서치에서는 5.0이후에 패싯 방식의 통계방식을 과감히 버리고 독자적인 집계 API를 내놓았다. 집계 API는 기본적으로 메모리를 기반으로 동작하기 때문에 대용량의 데이터 통계작업이 가능해졌다. 

## 검색 API

검색 API의 사용방식은 크게 두 가지 방식이 있다. 

1. HTTP URI 형태의 파라미터를 URI에 추가해 검색하는 방법
2. RESTful API방식인 QueryDSL을 사용해 요청 본문(Request Body)에 질의 내용을 추가해 검색하는 법

Request Body 방식(2)은 URI 방식(1)보다 제약 사항이 적기 때문에 현업에서는 Request Body식을 선호한다. Uri 방식은 간단한 검색을 하거나 디버깅할 때 간편하게 사용하는 경우에 종종 사용된다. 

간단한 표현식이라면 두 가지 형식을 섞어서 사용하는 것도 가능하다. 예를 들어, Query를 URI 방식으로 사용하고 나머지 기능을 JSON 형태로 사용해도 된다. 

엘라스틱서치는 인덱스에 저장된 문서를 검색하도록 다양한 검색 기능을 제공한다. 특정 문장이 검색어로 요청되면 분석기를 통해 분석된 토큰의 일치 여부를 판단해서 그 결과에 점수(score)를 매긴다. 이를 기반으로 순서를 적용해 결과를 사용자에게 최종적으로 출력하게 된다. 

검색의 대상이 되는 필드는 분석이 되는 Text 타입의 유형이 될 수도 있고 분석이 되지 않는 Keyword 타입의 유형이 될수도 있다. 

엘라스틱 서치에서는 다양한 검색 조건을 만족하기 위해 QueryDSL이라는 특수한 쿼리 문법을 제공한다. 

문장은 색인 시점에 term(텀)으로 분해된다. 토크나이저가 나눈 토큰을 토큰 필터로 처리하고 나면 그것이 바로 term이다. 

엘라스틱서치는 색인 시점에 분석기로 분석된 텀을 역색인 구조로 만들어 내부적으로 저장한다. 검색 시점에는 Keyword 타입과 같은 분석이 불가능한 데이터와 Text 타입과 같은 분석이 가능한 데이터를 구분해서 가능할 경우 분석기로 분석을 수행한다. 

검색 API는 기본적으로 질의(Query)를 기반으로 동작한다. 검색 질의에는 검색하고자 하는 각종 조건들을 명시할 수 있으며 동일한 조건을 URI, Request Body 검색 두 가지로 할 수 있다. 

URI 방법은 루씬에서 사용하는 전통적인 방식이고 Request Body는 RESTful API를 이용해 Request Body에 조건을 표시하는 방법이다. 

### URI 방식의 검색 질의

먼저 살펴볼 URI 방식의 검색 질의는 문서 ID인 _id값을 사용해 문서를 조회하는 방식이다. 결국 URL에 파라미터를 붙여 조회하는 식이다. 예컨데 123이라는 키를 가진 문서를 질의하려면 GET 메서드를 사용해 다음과 같이 검색할 수 있다. 

```
GET /movie/_doc/123?pretty=true
```

이 방식은 HTTP GET 요청을 활용하는 방식으로 파라미터를 key=value 형태로 전달한다. URL에 검색할 컬럼과 검색어를 직접 지정하면 검색이 수행된다. 파라미터로는 표현의 한계가 있어 복잡한 질의를 작성하는 것을 불가능하다. 그래도 웹브라우저를 통해 빠르게 테스트를 해볼 수 있다는 장점이 있다. 

### Request Body 방식의 검색 질의

URI 검색 질의는 여러 필드를 각기 다른 검색어로 질의하는 것이 어렵다. 쿼리의 조건이 복잡하고 길어지기 때문이다. 이럴 때는 JSON 방식으로 질의하는게 좋다. JSON  포맷을 이용해 RESTful방식으로 질의하면 매우 복잡한 질의도 쉽게 표현할 수 있고 여러 조건을 한번에 처리할 수 있다. 사용법은 간단하다. 앞서 만든 URI 파리미터를 JSON 포맷으로 옮기기만 하면 된다.

```
POST /{index 명}/_search {
	JSON 쿼리 구문
}
```

이 방식에서는 HTTP 요청시 본문에 JSON 형태로 검색 조건을 기록해서 검색을 요청한다. 간단한 검색은 언뜻 보면 URI 방식이 더 좋아 보일것이다. 하지만 JSON 형태로 작성하면 전체적인 방식이 더 잘 보일 것이다. 

### Search Shards API

Search Shards API를 이용하면 검색이 수행되는 노드 및 샤드에 대한 정보를 확인할 수 있다. 이런 정보는 질의를 최적화하거나 질의가 정상적으로 수행되지 않을때 문제를 해결하는데 유용하다.

```
POST movie_search/_search_shards
```

### Multi Search API

여러 건의 검색 요청을 통합해서 한번에 요청하고 한번에 결과를 가져올때 사용하는 API다. 

```
POST _msearch
{"index":"movie_auto"}
{"query": {"match_all":{}}, "from":0, "size": 10}
{"index":"movie_search"}
{"query": {"match_all":{}}, "from":0, "size": 10}
```

Multi Search API를 사용하면 동시에 여러 개의 색인에서 검색을 수행할 수 있으므로 사용자별 맞춤 페이지등을 구현할때 여러 인덱스에서 사용자별로 특화된 정보를 가져올때 유용하게 사용할 수 있다. 

기본적으로 모든 검색 요청은 Multi Index 및 Multi Type검색이 가능하다. 이러한 특성 덕에 다수의 인덱스를 검색해야 할때도 한번의 요청으로 검색 결과를 얻을 수 있다. 검색 요청시 "," 컴마를 이용해 다수의 인덱스 명을 입력할 수 있다. 이때 지정된 모든 인덱스가 검색 대상이 된다. 

아래 쿼리는 move_search, movie_auto 인덱스를 모두 검색한다. 
```
POST movie_search, movie_auto/_search 
```


### Count API

간혼 문서 본문의 내용보다 갯수가 몇개인지 알고 싶을때 있다. 이럴때 Count API를 사용한다. 
```
POST movie_search/_count?q=prdtYear:2017
```

### Validate API

쿼리를 실행하기에 앞서 쿼리가 유효하게 작성됬는지 검증한다.

```
POST movie_search/_validate/query?q=prdtYear:2017
```

### Explain API

문서 검색결과를 확인해보면 _score를 통해 우리가 검색한 키워드와 검색 결과가 얼마나 유사하닞 확인할 수 있다. 만일 이 문서가 가진 _score 값이 어떻게 계산된 것인지 자세한 정보를 알고 싶다면 Explain API를 사용하면 된다. 

### Profile API

쿼리에 대한 상세한 수행 계획과 각 수행 계획별로 수행된 시간을 알려주는 API이다. 성능을 튜닝하거나 디버깅할때 유용하게 사용할 수 있다. 다만 이 API는 쿼리에 대한 내용을 상세하기 설명하므로 결과가 매우 방대하다. 


> Written with [StackEdit](https://stackedit.io/).
<!--stackedit_data:
eyJoaXN0b3J5IjpbMjA0MjM5OTAwOSw4Nzk4NTI1NjMsODQ0Nj
M0MDU2XX0=
-->