# MongoDB 샤딩 아키텍처

컨피그 서버는 샤드 클러스터에서 사용자가 생성한 데이터베이스와 컬렉션들의 목록을 관리한다. 하지만 모든 데이터베이스와 컬렉션 목록을 관리하는 것이 아니라, 샤딩이 활성화된 데이터베이스와 컬렉션 정보만을 관리한다. 

샤딩이 되지 않은 객체들은 컨피그 서버가 아니라 각 샤드 서버가 로컬로 관리한다. 그리고 이런 샤드를 프라이머리 샤드라고 한다.

컨피그 서버는 각 컬렌션이 여러 사드 서버로 분산되기 위한 데이터 조각을 관리하는데 이것을 청크(Chunk) 한다. 

다음은 라우터 서버로 쿼리를 요청했을때 진행되는 과정을 나타낸다. 

1. 사용자 쿼리가 참조하는 컬렉션의 청크 메타 정보를 컨피그 서버로부터 가져와 라우터 메모리에 캐시
2. 사용자의 쿼리 조건에서 샤딩키를 찾음
	3. 쿼리 조건에 샤당 키가 있으면 해당 샤딩키를 가지는 모든 청크 정보를 라 우터 캐시에서 검색하여 청크를 가지는 모든 샤드로 사용자 쿼리를 요청
	4. 쿼리 존에 샤딩 키가 없다면 모든 샤드 서버로 사용자 쿼리 요청
3. 쿼리를 전송한 대상 샤드서버로부터 쿼리 결과가 오면 병합하여 결과를 반환

1번 과정은 라우터가 청크 메타 정보를 가지고 있지 않거나 라우터가 가진 청크 메타 정보가 오래돼서 맞지 않을 경우만 수행됩니다. 따라서 요청 쿼리가 많다고 해서 매번 컨피그 서버에 메타 정보를 조회하는 것은 아닙니다. 

# 컨피그 서버

컨피그 서버는 샤딩된 클러스터를 운영하는데 있어 필요한 모든 정보를 저장합니다. 컨피그 서버는 버전에 따라 차이가 있지만 다음과 같은 컬렉션을 가지고 있습니다. 

* databases
* collections
* chunks
* shards
* mongos
* settings
* version
* lockpings
* locks
* changelog
 
 이 컬렉션들은 모두 컨피그 서버에만 저장됩니다. 
 이 메타 데이터는 샤드 클러스터를 유지하기 위한 내부 관리 목적의 데이터 이므로 사용자가 직접 변경하거나 삭제해서는 안된다.

> Written with [StackEdit](https://stackedit.io/).
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTExNTc3NDkwMzIsMjAxMjYyMTE2Niw3ND
c3MTkxNzgsNzMwOTk4MTE2XX0=
-->